import Foundation

class ProductSuggestions {
    static let shared = ProductSuggestions()

    // Database of popular products with their default units
    private let products: [(name: String, unit: String, defaultQty: Int)] = [
        // Молочное
        ("Молоко", "л", 1),
        ("Молоко 2.5%", "л", 1),
        ("Молоко 3.2%", "л", 1),
        ("Молоко топлёное", "л", 1),
        ("Кефир", "л", 1),
        ("Кефир 1%", "л", 1),
        ("Кефир 2.5%", "л", 1),
        ("Ряженка", "л", 1),
        ("Сметана", "г", 200),
        ("Сметана 15%", "г", 200),
        ("Сметана 20%", "г", 200),
        ("Творог", "г", 200),
        ("Творог 5%", "г", 200),
        ("Творог 9%", "г", 200),
        ("Творог обезжиренный", "г", 200),
        ("Йогурт", "шт", 1),
        ("Йогурт питьевой", "шт", 1),
        ("Йогурт греческий", "шт", 1),
        ("Сыр", "г", 200),
        ("Сыр твёрдый", "г", 200),
        ("Сыр плавленый", "шт", 1),
        ("Сыр моцарелла", "г", 125),
        ("Сыр пармезан", "г", 100),
        ("Сыр фета", "г", 200),
        ("Масло сливочное", "г", 200),
        ("Масло 82.5%", "г", 200),
        ("Сливки", "мл", 200),
        ("Сливки 10%", "мл", 200),
        ("Сливки 33%", "мл", 200),

        // Яйца
        ("Яйца", "шт", 10),
        ("Яйца куриные", "шт", 10),
        ("Яйца С0", "шт", 10),
        ("Яйца С1", "шт", 10),
        ("Яйца перепелиные", "шт", 20),

        // Хлеб
        ("Хлеб", "шт", 1),
        ("Хлеб белый", "шт", 1),
        ("Хлеб чёрный", "шт", 1),
        ("Хлеб бородинский", "шт", 1),
        ("Хлеб ржаной", "шт", 1),
        ("Хлеб зерновой", "шт", 1),
        ("Хлеб для тостов", "уп", 1),
        ("Батон", "шт", 1),
        ("Батон нарезной", "шт", 1),
        ("Багет", "шт", 1),
        ("Булочки", "шт", 4),
        ("Лаваш", "уп", 1),
        ("Лепёшки", "шт", 2),

        // Овощи
        ("Картофель", "кг", 1),
        ("Картошка", "кг", 1),
        ("Морковь", "кг", 1),
        ("Лук репчатый", "кг", 1),
        ("Лук красный", "шт", 2),
        ("Лук зелёный", "пучок", 1),
        ("Чеснок", "шт", 1),
        ("Помидоры", "кг", 1),
        ("Томаты", "кг", 1),
        ("Томаты черри", "уп", 1),
        ("Огурцы", "кг", 1),
        ("Огурцы свежие", "кг", 1),
        ("Огурцы солёные", "шт", 3),
        ("Капуста", "шт", 1),
        ("Капуста белокочанная", "шт", 1),
        ("Капуста пекинская", "шт", 1),
        ("Капуста цветная", "шт", 1),
        ("Брокколи", "шт", 1),
        ("Перец болгарский", "шт", 3),
        ("Перец красный", "шт", 2),
        ("Перец жёлтый", "шт", 2),
        ("Баклажан", "шт", 2),
        ("Кабачок", "шт", 1),
        ("Свекла", "шт", 2),
        ("Редис", "пучок", 1),
        ("Салат", "шт", 1),
        ("Салат айсберг", "шт", 1),
        ("Салат романо", "шт", 1),
        ("Руккола", "уп", 1),
        ("Шпинат", "уп", 1),
        ("Укроп", "пучок", 1),
        ("Петрушка", "пучок", 1),
        ("Кинза", "пучок", 1),
        ("Базилик", "пучок", 1),
        ("Имбирь", "г", 50),
        ("Авокадо", "шт", 2),

        // Фрукты
        ("Яблоки", "кг", 1),
        ("Яблоки зелёные", "кг", 1),
        ("Яблоки красные", "кг", 1),
        ("Яблоки Гала", "кг", 1),
        ("Бананы", "кг", 1),
        ("Апельсины", "кг", 1),
        ("Мандарины", "кг", 1),
        ("Лимон", "шт", 2),
        ("Лайм", "шт", 2),
        ("Грейпфрут", "шт", 1),
        ("Груши", "кг", 1),
        ("Виноград", "кг", 1),
        ("Виноград зелёный", "кг", 1),
        ("Виноград красный", "кг", 1),
        ("Клубника", "г", 300),
        ("Малина", "г", 200),
        ("Черника", "г", 200),
        ("Голубика", "г", 200),
        ("Персики", "кг", 1),
        ("Нектарины", "кг", 1),
        ("Сливы", "кг", 1),
        ("Абрикосы", "кг", 1),
        ("Киви", "шт", 3),
        ("Манго", "шт", 1),
        ("Ананас", "шт", 1),
        ("Арбуз", "шт", 1),
        ("Дыня", "шт", 1),
        ("Гранат", "шт", 1),
        ("Хурма", "шт", 2),

        // Мясо
        ("Курица", "кг", 1),
        ("Куриное филе", "кг", 1),
        ("Куриная грудка", "кг", 1),
        ("Куриные ножки", "кг", 1),
        ("Куриные крылышки", "кг", 1),
        ("Куриный фарш", "кг", 1),
        ("Говядина", "кг", 1),
        ("Говяжий фарш", "кг", 1),
        ("Говяжья вырезка", "кг", 1),
        ("Свинина", "кг", 1),
        ("Свиной фарш", "кг", 1),
        ("Свиная шея", "кг", 1),
        ("Свиные рёбра", "кг", 1),
        ("Фарш смешанный", "кг", 1),
        ("Индейка", "кг", 1),
        ("Индейка филе", "кг", 1),
        ("Колбаса", "г", 300),
        ("Колбаса варёная", "г", 300),
        ("Колбаса копчёная", "г", 200),
        ("Сосиски", "уп", 1),
        ("Сардельки", "уп", 1),
        ("Ветчина", "г", 200),
        ("Бекон", "уп", 1),
        ("Шашлык", "кг", 1),

        // Рыба
        ("Рыба", "кг", 1),
        ("Лосось", "г", 300),
        ("Лосось филе", "г", 300),
        ("Сёмга", "г", 300),
        ("Сёмга слабосолёная", "г", 200),
        ("Форель", "г", 300),
        ("Треска", "г", 400),
        ("Минтай", "г", 500),
        ("Скумбрия", "шт", 1),
        ("Скумбрия копчёная", "шт", 1),
        ("Селёдка", "шт", 1),
        ("Селёдка солёная", "г", 300),
        ("Тунец консервы", "шт", 1),
        ("Креветки", "г", 300),
        ("Креветки очищенные", "г", 200),
        ("Кальмары", "г", 300),
        ("Мидии", "г", 300),
        ("Икра красная", "г", 100),

        // Крупы и макароны
        ("Рис", "кг", 1),
        ("Рис длиннозёрный", "кг", 1),
        ("Рис круглозёрный", "кг", 1),
        ("Рис басмати", "кг", 1),
        ("Гречка", "кг", 1),
        ("Гречневая крупа", "кг", 1),
        ("Овсянка", "г", 500),
        ("Овсяные хлопья", "г", 500),
        ("Пшено", "г", 500),
        ("Перловка", "г", 500),
        ("Манка", "г", 500),
        ("Булгур", "г", 500),
        ("Кускус", "г", 500),
        ("Киноа", "г", 300),
        ("Макароны", "г", 500),
        ("Спагетти", "г", 500),
        ("Пенне", "г", 500),
        ("Фузилли", "г", 500),
        ("Лапша", "г", 400),
        ("Лапша яичная", "г", 400),
        ("Вермишель", "г", 400),

        // Консервы
        ("Горошек консервированный", "шт", 1),
        ("Кукуруза консервированная", "шт", 1),
        ("Фасоль консервированная", "шт", 1),
        ("Оливки", "шт", 1),
        ("Маслины", "шт", 1),
        ("Томатная паста", "шт", 1),
        ("Томаты в собственном соку", "шт", 1),

        // Напитки
        ("Вода", "л", 2),
        ("Вода питьевая", "л", 5),
        ("Вода газированная", "л", 1),
        ("Сок", "л", 1),
        ("Сок апельсиновый", "л", 1),
        ("Сок яблочный", "л", 1),
        ("Сок мультифрукт", "л", 1),
        ("Чай", "уп", 1),
        ("Чай чёрный", "уп", 1),
        ("Чай зелёный", "уп", 1),
        ("Чай в пакетиках", "уп", 1),
        ("Кофе", "уп", 1),
        ("Кофе молотый", "г", 250),
        ("Кофе растворимый", "г", 100),
        ("Кофе в зёрнах", "г", 500),
        ("Какао", "г", 200),
        ("Лимонад", "л", 1),
        ("Кола", "л", 1),
        ("Квас", "л", 1),
        ("Пиво", "л", 1),
        ("Вино", "л", 1),
        ("Вино красное", "л", 1),
        ("Вино белое", "л", 1),

        // Сладости
        ("Сахар", "кг", 1),
        ("Сахар-песок", "кг", 1),
        ("Шоколад", "шт", 1),
        ("Шоколад молочный", "шт", 1),
        ("Шоколад тёмный", "шт", 1),
        ("Конфеты", "г", 200),
        ("Печенье", "уп", 1),
        ("Вафли", "уп", 1),
        ("Торт", "шт", 1),
        ("Пирожное", "шт", 2),
        ("Мороженое", "шт", 1),
        ("Мёд", "г", 300),
        ("Варенье", "шт", 1),
        ("Джем", "шт", 1),
        ("Сгущёнка", "шт", 1),

        // Масло и соусы
        ("Масло подсолнечное", "л", 1),
        ("Масло оливковое", "мл", 500),
        ("Масло растительное", "л", 1),
        ("Майонез", "г", 200),
        ("Кетчуп", "г", 350),
        ("Горчица", "шт", 1),
        ("Соевый соус", "мл", 200),
        ("Уксус", "мл", 250),
        ("Соль", "кг", 1),
        ("Перец чёрный", "г", 50),
        ("Специи", "уп", 1),

        // Бытовое
        ("Туалетная бумага", "уп", 1),
        ("Бумажные полотенца", "уп", 1),
        ("Салфетки", "уп", 1),
        ("Мыло", "шт", 1),
        ("Мыло жидкое", "шт", 1),
        ("Шампунь", "шт", 1),
        ("Кондиционер для волос", "шт", 1),
        ("Гель для душа", "шт", 1),
        ("Зубная паста", "шт", 1),
        ("Зубная щётка", "шт", 1),
        ("Дезодорант", "шт", 1),
        ("Стиральный порошок", "уп", 1),
        ("Гель для стирки", "шт", 1),
        ("Средство для посуды", "шт", 1),
        ("Губки для посуды", "уп", 1),
        ("Пакеты для мусора", "уп", 1),
        ("Пищевая плёнка", "уп", 1),
        ("Фольга", "уп", 1),
    ]

    private init() {}

    /// Get suggestions matching the input text
    func suggestions(for input: String, limit: Int = 8) -> [ProductSuggestion] {
        let trimmed = input.trimmingCharacters(in: .whitespaces).lowercased()
        guard trimmed.count >= 2 else { return [] }

        var results: [(product: (name: String, unit: String, defaultQty: Int), score: Int)] = []

        for product in products {
            let productLower = product.name.lowercased()

            // Exact match at start gets highest score
            if productLower.hasPrefix(trimmed) {
                let score = 100 - productLower.count // Shorter matches first
                results.append((product, score))
            }
            // Contains match gets lower score
            else if productLower.contains(trimmed) {
                let score = 50 - productLower.count
                results.append((product, score))
            }
        }

        // Sort by score (higher is better) and take top results
        let sorted = results.sorted { $0.score > $1.score }
        return Array(sorted.prefix(limit)).map {
            ProductSuggestion(name: $0.product.name, unit: $0.product.unit, defaultQuantity: $0.product.defaultQty)
        }
    }

    /// Get all products in a category
    func products(in categoryKeyword: String) -> [ProductSuggestion] {
        let detector = CategoryDetector.shared
        return products
            .filter { detector.detectCategory(for: $0.name).keywords.contains(where: { $0.contains(categoryKeyword) }) }
            .map { ProductSuggestion(name: $0.name, unit: $0.unit, defaultQuantity: $0.defaultQty) }
    }
}

struct ProductSuggestion: Identifiable, Hashable {
    let id = UUID()
    let name: String
    let unit: String
    let defaultQuantity: Int
}
